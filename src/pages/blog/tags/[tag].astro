---
import MainLayout from "@layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import { CATEGORIES, DIFFICULTIES, SERIES } from "@/config";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog", ({ data }) => !data.draft);
  const allTags = [...new Set(allPosts.flatMap((post) => post.data.tags))];
  
  return allTags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: allPosts
        .filter((post) => post.data.tags.includes(tag))
        .sort((a, b) => {
          // Sort by series order if both have it, otherwise by date
          if (a.data.seriesOrder && b.data.seriesOrder) {
            return a.data.seriesOrder - b.data.seriesOrder;
          }
          return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
        }),
    },
  }));
}

interface Props {
  tag: string;
  posts: Awaited<ReturnType<typeof getCollection<"blog">>>;
}

const { tag, posts } = Astro.props;

const isSeries = tag.endsWith("-series");
const seriesMeta = isSeries ? SERIES[tag as keyof typeof SERIES] : null;

const formatDate = (date: Date) => date.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
---

<MainLayout 
  title={`${seriesMeta?.title || tag} | BlueRobin Tech Blog`} 
  description={seriesMeta?.description || `Articles tagged with ${tag}`}
>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="mb-12">
      {isSeries && seriesMeta ? (
        <>
          <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-aurora-100 dark:bg-aurora-900 text-aurora-700 dark:text-aurora-300 mb-4">
            üìö Series
          </div>
          <h1 class="text-3xl sm:text-4xl font-display font-bold text-slate-900 dark:text-slate-100 mb-4">
            {seriesMeta.title}
          </h1>
          <p class="text-lg text-slate-600 dark:text-slate-400">
            {seriesMeta.description}
          </p>
        </>
      ) : (
        <>
          <h1 class="text-3xl sm:text-4xl font-display font-bold text-slate-900 dark:text-slate-100 mb-4">
            Articles tagged: <span class="text-neural-600 dark:text-neural-400">{tag}</span>
          </h1>
          <p class="text-lg text-slate-600 dark:text-slate-400">
            {posts.length} article{posts.length !== 1 ? "s" : ""} found
          </p>
        </>
      )}
    </header>

    <div class="space-y-6">
      {posts.map((post, index) => {
        const categoryMeta = CATEGORIES[post.data.category];
        const difficultyMeta = DIFFICULTIES[post.data.difficulty];
        
        return (
          <article class="glass-card p-6 hover:shadow-lg transition-all">
            <div class="flex flex-col md:flex-row md:items-start gap-4">
              {/* Series Order Number */}
              {isSeries && post.data.seriesOrder && (
                <div class="flex-shrink-0 w-12 h-12 bg-neural-100 dark:bg-neural-900 rounded-full flex items-center justify-center">
                  <span class="text-lg font-bold text-neural-600 dark:text-neural-400">
                    {post.data.seriesOrder}
                  </span>
                </div>
              )}
              
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class={`text-xs px-2 py-0.5 rounded-full category-${post.data.category}`}>
                    {categoryMeta.icon} {post.data.category}
                  </span>
                  <span class={`text-xs px-2 py-0.5 rounded-full difficulty-${post.data.difficulty}`}>
                    {difficultyMeta.label}
                  </span>
                  {post.data.readTime && (
                    <span class="text-xs text-slate-500 dark:text-slate-400">
                      ‚è±Ô∏è {post.data.readTime}
                    </span>
                  )}
                </div>
                
                <a href={`/articles/${post.slug}/`}>
                  <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 hover:text-neural-600 dark:hover:text-neural-400 transition-colors mb-2">
                    {post.data.title}
                  </h2>
                </a>
                
                <p class="text-slate-600 dark:text-slate-400 mb-3">
                  {post.data.description}
                </p>
                
                <div class="flex flex-wrap items-center gap-2">
                  {post.data.tags.filter(t => t !== tag).slice(0, 4).map((t) => (
                    <a href={`/tags/${t}/`} class={`tag text-xs ${t.endsWith("-series") ? "tag-series" : ""}`}>
                      {t.replace("-series", "")}
                    </a>
                  ))}
                </div>
              </div>
              
              <div class="text-sm text-slate-500 dark:text-slate-400 md:text-right">
                <time datetime={post.data.pubDate.toISOString()}>
                  {formatDate(post.data.pubDate)}
                </time>
              </div>
            </div>
          </article>
        );
      })}
    </div>

    <div class="mt-8">
      <a href="/tags/" class="btn-secondary">
        ‚Üê All Tags
      </a>
    </div>
  </div>
</MainLayout>
