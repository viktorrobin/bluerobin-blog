---
import MainLayout from "@layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import { SERIES } from "@/config";

// Get all posts and extract unique tags
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const allTags = [...new Set(allPosts.flatMap((post) => post.data.tags))].sort();

// Separate series tags from regular tags
const seriesTags = allTags.filter((tag) => tag.endsWith("-series"));
const regularTags = allTags.filter((tag) => !tag.endsWith("-series"));

// Count posts per tag
const tagCounts = allTags.reduce((acc, tag) => {
  acc[tag] = allPosts.filter((post) => post.data.tags.includes(tag)).length;
  return acc;
}, {} as Record<string, number>);
---

<MainLayout title="Tags | BlueRobin Tech Blog" description="Browse articles by topic">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="mb-12">
      <h1 class="text-3xl sm:text-4xl font-display font-bold text-slate-900 dark:text-slate-100 mb-4">
        Browse by Tag
      </h1>
      <p class="text-lg text-slate-600 dark:text-slate-400">
        Find articles by topic or explore a complete series.
      </p>
    </header>

    {/* Series Section */}
    {seriesTags.length > 0 && (
      <section class="mb-12">
        <h2 class="text-2xl font-display font-bold text-slate-900 dark:text-slate-100 mb-6">
          ğŸ“š Article Series
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {seriesTags.map((tag) => {
            const seriesKey = tag as keyof typeof SERIES;
            const seriesMeta = SERIES[seriesKey];
            return (
              <a href={`/tags/${tag}/`} class="glass-card p-6 hover:shadow-lg transition-all hover:-translate-y-1">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-semibold text-slate-900 dark:text-slate-100">
                    {seriesMeta?.title || tag.replace("-series", "")}
                  </h3>
                  <span class="text-sm text-slate-500 dark:text-slate-400">
                    {tagCounts[tag]} articles
                  </span>
                </div>
                {seriesMeta && (
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    {seriesMeta.description}
                  </p>
                )}
              </a>
            );
          })}
        </div>
      </section>
    )}

    {/* All Tags */}
    <section>
      <h2 class="text-2xl font-display font-bold text-slate-900 dark:text-slate-100 mb-6">
        ğŸ·ï¸ All Tags
      </h2>
      {regularTags.length === 0 ? (
        <div class="glass-card p-8 text-center">
          <p class="text-slate-600 dark:text-slate-400">
            Tags will appear here once articles are published.
          </p>
        </div>
      ) : (
        <div class="flex flex-wrap gap-3">
          {regularTags.map((tag) => (
            <a href={`/tags/${tag}/`} class="tag">
              {tag}
              <span class="ml-2 text-xs text-slate-500 dark:text-slate-400">
                ({tagCounts[tag]})
              </span>
            </a>
          ))}
        </div>
      )}
    </section>
  </div>
</MainLayout>
